/**
 * Match balanced string pairs, like `{` and `}` or `<b>` and `</b>`.
 * Supports regular expressions as well!
 */
class BalancedMatch {
  /**
   * Get the first non-nested matching pair of `a` and `b` in `str`.
   * Returns an object with the following keys:
   * - `start`: the index of the first match of `a`
   * - `end`: the index of the matching `b`
   * - `pre`: the preamble, `a` and `b` not included
   * - `body`: the match, `a` and `b` not included
   * - `post`: the postscript, `a` and `b` not included
   * If there's no match, `undefined` will be returned.
   * If the `str` contains more `a` than `b` or there are unmatched pairs,
   * the first match that was closed will be used.
   * @param {string|RegExp} a - The opening delimiter
   * @param {string|RegExp} b - The closing delimiter
   * @param {string} str - The string to search in
   * @returns {Object|undefined} - The matched result or undefined if no match
   */
  static match(a, b, str) {
    const matchStart = str.indexOf(a);
    if (matchStart === -1) return undefined;

    let depth = 0;
    let start = matchStart;
    let end = -1;

    for (let i = matchStart; i < str.length; i++) {
      if (str[i] === a) {
        depth++;
      } else if (str[i] === b) {
        depth--;
        if (depth === 0) {
          end = i;
          break;
        }
      }
    }

    if (end === -1) return undefined;

    const pre = str.substring(0, start);
    const body = str.substring(start + 1, end);
    const post = str.substring(end + 1);

    return { start, end, pre, body, post };
  }

  /**
   * For the first non-nested matching pair of `a` and `b` in `str`,
   * return an array with indexes: `[ <a index>, <b index> ]`.
   * If there's no match, `undefined` will be returned.
   * If the `str` contains more `a` than `b` or there are unmatched pairs,
   * the first match that was closed will be used.
   * @param {string|RegExp} a - The opening delimiter
   * @param {string|RegExp} b - The closing delimiter
   * @param {string} str - The string to search in
   * @returns {Array|undefined} - The range of matched indexes or undefined if no match
   */
  static range(a, b, str) {
    const match = BalancedMatch.match(a, b, str);
    if (!match) return undefined;
    return [match.start, match.end];
  }
}

// Example usage:
console.log(BalancedMatch.match('{', '}', 'pre{in{nested}}post'));
console.log(BalancedMatch.match('{', '}', 'pre{first}between{second}post'));
console.log(BalancedMatch.match(/\s+\{\s+/, /\s+\}\s+/, 'pre  {   in{nest}   }  post'));
